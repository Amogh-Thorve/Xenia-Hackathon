{% extends "base.html" %}
{% block title %}Chat - {{ club.name }}{% endblock %}

{% block content %}
<div class="chat-layout fade-in">
    <!-- LEFT PANEL: Channels -->
    <aside class="chat-sidebar left-sidebar glass-card-static">
        <div class="sidebar-header">
            <div class="club-info">
                <img src="{{ url_for('static', filename='club_logos/' + club.image_file) }}" alt="{{ club.name }}"
                    class="club-avatar-small">
                <h3 class="club-name-truncate">{{ club.name }}</h3>
            </div>
        </div>

        <div class="channel-list">
            <div class="channel-group-label">TEXT CHANNELS</div>
            <a href="#" class="channel-item active">
                <span class="hashtag">#</span>
                <span class="channel-name">general</span>
            </a>
        </div>
    </aside>

    <!-- CENTER PANEL: Messages -->
    <main class="chat-main glass-card-static">
        <header class="chat-header">
            <div class="chat-header-info">
                <span class="hashtag-large">#</span>
                <div class="header-text">
                    <h2>general</h2>
                    <span class="header-topic">General discussion for {{ club.name }}</span>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="btn-icon-ghost" id="show-pinned-btn" title="Pinned Messages"><span
                        class="emoji">ðŸ“Œ</span></button>
            </div>
        </header>

        <div class="messages-container" id="messages-container">
            <!-- Messages will be loaded here -->
        </div>

        <div class="chat-input-area">
            <div class="input-wrapper glass-panel">
                <button class="btn-attach" title="Add Attachment">+</button>
                <input type="text" id="chat-input" placeholder="Message #general" class="chat-input-field">
            </div>
            <div class="typing-help text-xs text-muted mt-1">
                Press <strong>Enter</strong> to send
            </div>
        </div>
    </main>

    <!-- RIGHT PANEL: Members -->
    <aside class="chat-sidebar right-sidebar glass-card-static">
        <div class="sidebar-header">
            <h3>Members</h3>
        </div>

        <div class="members-list">
            <div class="member-group-label">MANAGERS â€” 1</div>
            <div class="member-item">
                <div class="member-avatar-status">
                    <div class="avatar-circle small" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">{{
                        club.manager.username[0].upper() }}</div>
                    <span class="status-dot online"></span>
                </div>
                <div class="member-info">
                    <span class="member-name username-manager">{{ club.manager.username }}</span>
                </div>
            </div>
        </div>
    </aside>
</div>

<!-- PINNED MESSAGES MODAL -->
<div id="pinned-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content glass-card-static">
        <div class="modal-header">
            <h3>Pinned Messages</h3>
            <button class="close-btn" onclick="togglePinnedModal()">Ã—</button>
        </div>
        <div id="pinned-messages-list" class="pinned-list">
            <!-- Pinned messages load here -->
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .modal-content {
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 2rem;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
    }

    .pinned-item {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        border-left: 3px solid var(--accent-primary);
    }

    .pinned-item .meta {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .message-group .pin-indicator {
        font-size: 0.8rem;
        color: var(--accent-amber);
        margin-left: 0.5rem;
    }
</style>

<script>
    const messagesContainer = document.getElementById('messages-container');
    const chatInput = document.getElementById('chat-input');
    const pinnedModal = document.getElementById('pinned-modal');
    const pinnedList = document.getElementById('pinned-messages-list');
    const clubId = {{ club.id }};
    const isManager = {{ 'true' if membership_status == 'manager' else 'false' }};

    function togglePinnedModal() {
        pinnedModal.style.display = pinnedModal.style.display === 'none' ? 'flex' : 'none';
        if (pinnedModal.style.display === 'flex') {
            fetchPinnedMessages();
        }
    }

    document.getElementById('show-pinned-btn').addEventListener('click', togglePinnedModal);

    function appendMessage(msg) {
        const div = document.createElement('div');
        div.className = 'message-group fade-in';
        div.innerHTML = `
            <div class="message-avatar">
                <div class="avatar-circle" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">${msg.username[0].toUpperCase()}</div>
            </div>
            <div class="message-content-wrapper">
                <div class="message-header">
                    <span class="username">${msg.username}</span>
                    <span class="timestamp">${msg.timestamp}</span>
                    ${msg.is_pinned ? '<span class="pin-indicator" title="Pinned Message">ðŸ“Œ</span>' : ''}
                </div>
                <div class="message-bubble">
                    <p>${msg.content}</p>
                </div>
            </div>
            ${isManager ? `<div class="message-actions">
                <button class="action-btn" onclick="togglePin(${msg.id})" title="${msg.is_pinned ? 'Unpin' : 'Pin'}">ðŸ“Œ</button>
            </div>` : ''}
        `;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function togglePin(msgId) {
        const response = await fetch(`/api/messages/${msgId}/pin`, { method: 'POST' });
        if (response.ok) {
            fetchMessages(); // Refresh to update pin status
        }
    }

    async function fetchPinnedMessages() {
        const response = await fetch(`/api/club/${clubId}/pinned`);
        const messages = await response.json();
        pinnedList.innerHTML = messages.length === 0 ? '<p class="text-muted">No pinned messages yet.</p>' : '';
        messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'pinned-item';
            div.innerHTML = `
                <div class="meta"><strong>${msg.username}</strong> â€¢ ${msg.timestamp}</div>
                <div class="content">${msg.content}</div>
            `;
            pinnedList.appendChild(div);
        });
    }

    async function fetchMessages() {
        const response = await fetch(`/api/club/${clubId}/messages`);
        const messages = await response.json();
        messagesContainer.innerHTML = '';
        messages.forEach(appendMessage);
    }

    chatInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const content = chatInput.value.trim();
            if (!content) return;

            chatInput.value = '';
            const response = await fetch(`/api/club/${clubId}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                const newMsg = await response.json();
                appendMessage(newMsg);
            }
        }
    });

    fetchMessages();
    setInterval(fetchMessages, 5000);
</script>
{% endblock %}